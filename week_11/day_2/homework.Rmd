---
title: "Week 11 Day 2 HW"
output: html_notebook
---

```{r}
library(rpart) #for creating decision tree with rpart()
library(rpart.plot) #for plotting decision tree with rpart.plot()
library(tidyverse)
library(GGally) #for ggpairs()
library(janitor) #for tabyl()
library(modelr) #for adding predictions
library(caret) #for confusion matrix conf_mat()
```


```{r}
titanic_set <- read_csv('data/titanic_decision_tree_data.csv')

shuffle_index <- sample(1:nrow(titanic_set))

# shuffle the data so class order isn't in order - need this for training/testing split later on 
titanic_set <- titanic_set[shuffle_index, ]
```

```{r}
titanic_set %>% 
  summarise(across(.fns = ~sum(is.na(.x))))
```
QUESTION 1
```{r}
titanic_trim <- titanic_set %>% 
  filter(is.na(survived) == FALSE) %>% 
  mutate(sex = as.factor(sex),
         class = factor(pclass, levels = c(3,2,1), labels = c("Lower", "Middle", "Upper")), 
         survived_flag = factor(survived, levels = c(0,1), labels = c("No", "Yes")),
         embarked = as.factor(embarked),
         age_status = case_when(age <= 16 ~ "child",
                                age > 16 ~ "adult")) %>% 
  select(-c("X1", "passenger_id", "age", "name", "ticket", "fare", "pclass", "cabin", "survived")) %>% 
  drop_na()
```

```{r}
titanic_trim %>% 
  summarise(across(.fns = ~sum(is.na(.x))))
```
QUESTION 2
```{r}
titanic_trim %>% 
  ggpairs(columns = c("class", "sex", "sib_sp", "survived_flag"),
          progress = FALSE)
```

This shows that there is a strong relationship for survival with sex and pclass.

```{r}
titanic_trim %>% 
  ggpairs(columns = c("parch", "embarked", "age_status", "survived_flag"),
          progress = FALSE)
```
This suggests relationships with parch and embarked.

So from these plots I would expect that the following variables could be useful as predictors:
- sex
- pclass
- parch
- embarked

QUESTION 3: CREATE TEST/TRAINING DATA
```{r}
n_data <- nrow(titanic_trim)

test_index <- sample(1:n_data, size = n_data * 0.2)

titanic_test <- slice(titanic_trim, test_index)

titanic_train <- slice(titanic_trim, -test_index)
```

```{r}
titanic_train %>% 
  tabyl(survived_flag)
```

```{r}
titanic_test %>% 
  tabyl(survived_flag)
```

```{r}
titanic_trim %>% 
  tabyl(survived_flag)
```

Split of 80:20 between train/test to give a reasonable size of dataset for each.
Tables above show that the sets are fairly well balanced on survival.


QUESTION 4: DECISION TREE
```{r}
#Fit model
titanic_fit <- rpart(
  formula = survived_flag ~ .,
  data = titanic_train,
  method = "class"
)
```

```{r}
#Plot decision tree
rpart.plot(
  titanic_fit, 
  yesno = 2,
  fallen.leaves = TRUE,
  faclen = 6,
  type = 4,
  digits = 4,
  extra = 101
)

```
QUESTION 5
This decision tree shows that the most important factor is sex: 

QUESTION 6
```{r}
titanic_test_pred <- titanic_test %>% 
  add_predictions(titanic_fit, type = "class")
```

```{r}
confusionMatrix(titanic_test_pred$pred, titanic_test_pred$survived_flag)
```

